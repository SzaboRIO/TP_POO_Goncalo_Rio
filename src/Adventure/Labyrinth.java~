package Adventure;

import Entities.Hero;
import Entities.NPC;
import Entities.Vendor;
import java.util.ArrayList;
import java.util.Random;
import java.util.Scanner;

public class Labyrinth {
    private final Hero hero;
    private final Scanner scanner;
    private final Random random;
    private final Vendor vendor;
    private final ArrayList<String> locations = new ArrayList<>();
    private final ArrayList<NPC> normalEnemies = new ArrayList<>();
    private final ArrayList<NPC> miniBosses = new ArrayList<>();

    private int currentLocationIndex = 0;

    public Labyrinth(Hero hero) {
        this.hero = hero;
        this.scanner = new Scanner(System.in);
        this.random = new Random();
        this.vendor = new Vendor();
        initializeLocations();
        initializeEnemies();
    }

    private void initializeLocations() {
        locations.add("The Shire ğŸŒ¿");
        locations.add("Bree ğŸ¡");
        locations.add("Chetwood ğŸŒ²");
        locations.add("Weathertop ğŸ”ï¸");
        locations.add("Rivendell ğŸ°");
        locations.add("Goblin Caves ğŸšï¸");
        locations.add("Mines of Moria âš’ï¸");
        locations.add("Rohan ğŸ‡");
        locations.add("Fangorn Forest ğŸŒ²");
        locations.add("Helmâ€™s Deep ğŸ°");
        locations.add("Isengard ğŸ°");
        locations.add("Minas Morgul ğŸ°");
        locations.add("Cirith Ungol ğŸ•·ï¸");
        locations.add("Black Gate ğŸšª");
        locations.add("Plains of Gorgoroth ğŸ”¥");
        locations.add("Dark Tower of Barad-dÃ»r âš«");
    }

    private void initializeEnemies() {
        // Normal enemies (Random Encounters)
        normalEnemies.add(new NPC("Orc Warrior", 35, 8, 15));
        normalEnemies.add(new NPC("Goblin Scout", 30, 5, 10));
        normalEnemies.add(new NPC("Uruk-hai", 45, 12, 20));
        normalEnemies.add(new NPC("Haradrim Soldier", 35, 10, 18));
        normalEnemies.add(new NPC("Warg Rider", 50, 14, 22));

        // Mini-Bosses (Fixed at Locations)
        miniBosses.add(new NPC("NazgÃ»l ğŸ‘ï¸", 80, 18, 40)); // Weathertop
        miniBosses.add(new NPC("Balrog ğŸ”¥", 150, 30, 100)); // Moria
        miniBosses.add(new NPC("GrÃ­ma Wormtongue ğŸ", 70, 15, 50)); // Rohan
        miniBosses.add(new NPC("Saruman ğŸ§™â€â™‚ï¸", 120, 28, 150)); // Isengard
        miniBosses.add(new NPC("Shelob ğŸ•·ï¸", 160, 35, 200)); // Cirith Ungol
        miniBosses.add(new NPC("Witch-king of Angmar ğŸ‘‘", 200, 40, 250)); // Black Gate
    }


    private void finalBossBattle() {
        System.out.println("\nğŸ”¥ The fires of **Mount Doom** crackle around you...");
        System.out.println("âš« **The Dark Tower of Barad-dÃ»r looms above...**");
        System.out.println("ğŸ”¥ğŸ‘ï¸ğŸ”¥ **Sauron, the Dark Lord, stands before you!**");

        NPC sauron = new NPC("Sauron âš«", 300, 50, 1000);
        battle(sauron);

        if (hero.getHp() > 0) {
            System.out.println("\nğŸ† " + hero.getName() + " has **defeated** Sauron!");
            System.out.println("ğŸ‘‘ **Middle-earth is free once more!**");
            System.out.println("ğŸŒ… You leave Mordor, forever remembered as a legend.");
            System.out.println("ğŸ­ Thank you for playing!");
            System.exit(0);
        } else {
            System.out.println("â˜ ï¸ " + hero.getName() + " was slain... Middle-earth falls into darkness...");
            System.exit(0);
        }
    }


    public void start() {
        System.out.println("ğŸ° " + hero.getName() + " embarks on a journey through Middle-earth...");
        navigateLocation();
    }

    private void navigateLocation() {
        System.out.println("\nğŸ›‘ **Arriving at " + locations.get(currentLocationIndex) + "**");

        if (currentLocationIndex == 15) {
            finalBossBattle(); // Sauron appears when reaching Barad-dÃ»r
            return;
        }

        // Mini-Boss fights at specific locations
        if (miniBosses.size() > 0 && (currentLocationIndex == 3 || currentLocationIndex == 6 || currentLocationIndex == 8 || currentLocationIndex == 10 || currentLocationIndex == 12 || currentLocationIndex == 14)) {
            encounterMiniBoss();
        } else {
            encounterEnemy(); // Normal encounter if no mini-boss
        }

        // Present path choices
        choosePath();
    }

    private void encounterEnemy() {
        // Select a random enemy from the normal enemies list
        NPC enemy = normalEnemies.get(random.nextInt(normalEnemies.size()));
        System.out.println("âš”ï¸ An enemy appears! " + enemy.getName() + " is blocking your path!");
        System.out.println("ğŸ’€ " + enemy.getName() + " (HP: " + enemy.getHp() + ", Strength: " + enemy.getStrength() + ")");

        // Start battle with the chosen enemy
        battle(enemy);
    }

    private void encounterMiniBoss() {
        if (miniBosses.isEmpty()) {
            System.out.println("ğŸ¤· No mini-boss remains... This path is empty.");
            return;
        }

        // Get the next mini-boss in order
        NPC miniBoss = miniBosses.remove(0);
        System.out.println("ğŸ‘¹ A **Mini-Boss** appears: " + miniBoss.getName() + "!");
        System.out.println("ğŸ’€ " + miniBoss.getName() + " (HP: " + miniBoss.getHp() + ", Strength: " + miniBoss.getStrength() + ")");

        // Start battle with the mini-boss
        battle(miniBoss);
    }

    private void battle(NPC enemy) {
        while (hero.getHp() > 0 && enemy.getHp() > 0) {
            System.out.println("\nğŸ”¥ Choose your action:");
            System.out.println("[1] Normal Attack");
            System.out.println("[2] Special Attack (One-time per fight)");
            System.out.println("[3] Use a Combat Consumable");
            System.out.println("[4] Attempt to Flee ğŸƒğŸ’¨");
            System.out.print("Your choice: ");
            int choice = scanner.nextInt();

            switch (choice) {
                case 1 -> {
                    int damage = hero.getStrength();
                    enemy.takeDamage(damage);
                    System.out.println("ğŸ—¡ï¸ " + hero.getName() + " attacks for " + damage + " damage!");
                }
                case 2 -> {
                    int damage = hero.getStrength() * 2;
                    enemy.takeDamage(damage);
                    System.out.println("ğŸ’¥ " + hero.getName() + " unleashes a Special Attack for " + damage + " damage!");
                }
                case 3 -> {
                    System.out.println("ğŸ’ No consumables implemented yet!");
                }
                case 4 -> {
                    if (attemptFlee(enemy)) return; // If successful, hero escapes
                }
                default -> {
                    System.out.println("âŒ Invalid choice. Try again.");
                    continue;
                }
            }

            if (!enemy.isDefeated()) {
                int enemyDamage = enemy.getStrength();
                hero.setHp(hero.getHp() - enemyDamage);
                System.out.println("ğŸ’€ " + enemy.getName() + " strikes back for " + enemyDamage + " damage!");
            }
        }

        if (hero.getHp() > 0) {
            System.out.println("ğŸ† " + hero.getName() + " has defeated " + enemy.getName() + "!");
        } else {
            System.out.println("â˜ ï¸ " + hero.getName() + " has fallen...");
            System.exit(0);
        }
    }

    private boolean attemptFlee(NPC enemy) {
        System.out.println("ğŸƒğŸ’¨ " + hero.getName() + " tries to flee...");
        boolean canFlee = random.nextBoolean(); // 50% chance to succeed

        if (canFlee) {
            System.out.println("âœ… Success! " + hero.getName() + " escapes to the next location!");
            navigateLocation(); // Moves to the next location
            return true;
        } else {
            System.out.println("âŒ Failed! " + enemy.getName() + " lands a free attack!");
            int enemyDamage = enemy.getStrength();
            hero.setHp(hero.getHp() - enemyDamage);
            System.out.println("ğŸ’€ " + enemy.getName() + " hits for " + enemyDamage + " damage!");
            return false;
        }
    }

    private void choosePath() {
        System.out.println("\nğŸ¹ Choose your next action:");
        System.out.println("[1] Take the safer route (More encounters, but easier)");
        System.out.println("[2] Take the dangerous shortcut (Fewer encounters, but stronger enemies)");
        System.out.print("Your choice: ");

        int choice = scanner.nextInt();
        currentLocationIndex += (choice == 1) ? 1 : 2;
        navigateLocation();
    }
}
